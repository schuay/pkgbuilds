pkgname=stone-soup-git
pkgver=20100522
pkgrel=1
pkgdesc="Community maintained variant of Linley's Dungeon Crawl (git development version)"
arch=('i686' 'x86_64' 'ppc')
url="http://crawl.develz.org/"
depends=('lua' 'ncurses') 
makedepends=('git' 'gcc' 'bison' 'flex')
conflicts=('crawl' 'stone-soup')
license=('custom')

_gitroot="git://crawl-ref.git.sourceforge.net/gitroot/crawl-ref/crawl-ref"
_gitname="crawl-ref"

build() {
    cd "$srcdir"
    msg "Connecting to GIT server...."

    if [ -d $_gitname ] ; then
      cd $_gitname && git pull origin
      msg "The local files are updated."
    else
      git clone $_gitroot $_gitname
    fi

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    cd $srcdir/$_gitname/crawl-ref/source
    sed -i 's|bin_prefix    := bin|bin_prefix    := usr/bin|' makefile || return 1
    sed -i 's/INSTALL_UGRP := games:games/INSTALL_UGRP := root:games/' makefile || return 1

    # to build the tiles version, add the following line after USE_UNICODE:
    #   TILES=y \
    make DESTDIR=$pkgdir \
        SAVEDIR="/usr/share/stone-soup/save" \
        DATADIR="/usr/share/stone-soup/data" \
        USE_UNICODE=y \
    install || return 1

    install -D -m644 ../licence.txt "$pkgdir/usr/share/licenses/stone-soup/license.txt" || return 1
}
