pkgname=stone-soup-nettiles
pkgver=20100522
pkgrel=1
pkgdesc="Community maintained variant of Linley's Dungeon Crawl (nettiles version)"
arch=('i686' 'x86_64' 'ppc')
url="http://repo.or.cz/w/crawl/crawl-nettiles.git"
depends=('lua' 'ncurses') 
makedepends=('git' 'gcc' 'bison' 'flex')
conflicts=('crawl' 'stone-soup' 'stone-soup-git' 'stone-soup-tile')
license=('custom')
backup=('usr/share/stone-soup/data/settings/init.txt' 'usr/share/stone-soup/data/settings/tiles_options.txt')
source=('debug.patch' 'gen_ver.patch')
md5sums=('89b14e3aa5f7fed192100e8bb11b6f79' '94150051b0644e9132cfddef1438aa1f')

_gitroot="git://repo.or.cz/crawl/crawl-nettiles.git"
_gitname="crawl-nettiles"
_gittag="0.7.0-nettiles21"

build() {
    cd "$srcdir"
    msg "Connecting to GIT server...."

    if [ -d $_gitname ] ; then
      cd $_gitname
      git checkout master
      git pull origin || return 1
      git reset --hard || return 1
      msg "The local files are updated."
    else
      git clone $_gitroot $_gitname
    fi

    cd $srcdir/$_gitname
    git checkout $_gittag

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    # avoid bugs preventing a successful compilation from git
    patch -p0 < $startdir/debug.patch || return 1
    patch -p0 < $startdir/gen_ver.patch || return 1

    cd $srcdir/$_gitname/crawl-ref/source
    sed -i 's|bin_prefix    := bin|bin_prefix    := usr/bin|' makefile || return 1
    sed -i 's/INSTALL_UGRP := games:games/INSTALL_UGRP := root:games/' makefile || return 1

    make DESTDIR=$pkgdir \
        SAVEDIR="/usr/share/stone-soup/save" \
        DATADIR="/usr/share/stone-soup/data" \
	USE_UNICODE=y \
	NETTILES=y \
        install || return 1

    install -D -m644 ../licence.txt "$pkgdir/usr/share/licenses/stone-soup/license.txt" || return 1
}
